---
title: "Content analysis"
author: "Jae Yeon Kim"
output:
html_document: 
  toc: true
  theme: united
---

## 0. Setup 

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        irr, # for calculating inter-coder reliability score
        corrplot, # for visualizing correlation coefficients
        ggpubr, # for arranging ggplots   
        ggthemes, # for fancy ggplot themes
        gmodels, # quick summaries 
        patchwork # for arranging ggplots 
)

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/theme_publications.r")
theme_set(theme_Publication(14))

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/text_analysis.r")
```

## 1. Importing files 


```{r include=FALSE}

# Training data for classifying articles from Asian American newspapers 
training_asian <- read_csv("/home/jae/content-analysis-for-evaluating-ML-performances/raw_data/training_asian.csv") %>%
  dplyr::select(-contains("Notes")) %>%
  mutate(linked_progress_gran = ifelse(Promoting_collective_gains_A + Promoting_collective_gains_B >= 1, 1, 0),
         linked_hurt_gran = ifelse(Preventing_collective_losses_A + Preventing_collective_losses_B >= 1, 1, 0),
         linked_progress = ifelse(Promoting_collective_gains_A + Promoting_collective_gains_B == 2, 1, 0),
         linked_hurt = ifelse(Preventing_collective_losses_A + Preventing_collective_losses_B == 2, 1, 0))

# Training data for classifying articles from African American newspapers
training_black <- read_csv("/home/jae/content-analysis-for-evaluating-ML-performances/raw_data/training_black.csv") %>%
  dplyr::select(-contains("Notes")) %>%
  mutate(linked_progress_gran = ifelse(Promoting_collective_gains_A + Promoting_collective_gains_B >= 1, 1, 0),
         linked_hurt_gran = ifelse(Preventing_collective_losses_A + Preventing_collective_losses_B >= 1, 1, 0),
         linked_progress = ifelse(Promoting_collective_gains_A + Promoting_collective_gains_B == 2, 1, 0),
         linked_hurt = ifelse(Preventing_collective_losses_A + Preventing_collective_losses_B == 2, 1, 0))

# Dimensions 
dim(training_asian)
dim(training_black)

# Variable names
names(training_asian) == names(training_black)

```

## 2. Descriptive statistics 

### 2.1. Merging

```{r}

# Wrangling 

df <- bind_rows(
  mutate(training_asian, group = "Asian Americans"),
  mutate(training_black, group = "African Americans"))

```

### 2.2. Data visualization 

```{r}

df %>%
  gather(type, value, linked_progress, linked_hurt) %>%
  mutate(type = recode(type,
                       `linked_progress` = "Linked progress",
                       `linked_hurt` = "Linked hurt")) %>%
  group_by(group, type) %>%
  summarise(mean = mean(value), # summarize mean, standard deviation, and n 
            sd = sd(value),
            n = n()) %>%
  mutate(se = sd / sqrt(n), # calculate standard errors and confidence intervals 
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
  ggplot(aes(x = fct_reorder(type, mean), y = mean, ymax = upper.ci, ymin = lower.ci, col = group)) +
    geom_pointrange() + # point estimates plus confidence intervals 
    coord_flip() +
    scale_color_manual(name = "Group", labels = c("African Americans", "Asian Americans"), values=c("red","blue")) +
    labs(y= "Percentages of agreement", x = "Type",
         title = "Percentages of agreement",
         subtitle = "1: Perfect agreement, 0: Zero agreement",
         caption = "Ethnic NewsWatch",
         col = "Group") +
    theme(text = element_text(size = 15)) # large font size 

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_agreement.png")

```

#### 2.2.1. Checking the data balance 

```{r}

ggarrange(
df %>%              
  group_by(group, linked_progress) %>%
  add_count() %>%
  ggplot(aes(x = as.factor(linked_progress), y = n, fill = group)) +
    geom_col(position = "dodge") +
    scale_fill_manual(name = "Group", labels = c("African Americans", "Asian Americans"), values=c("red","blue")) +
    labs(x = "Values", y = "Frequency",
         title = "Linked progress",
         subtitle = "Yes = 1, No = 0",
         fill = "Group"),

df %>%
  group_by(group, linked_hurt) %>%
  add_count() %>%
  ggplot(aes(x = as.factor(linked_hurt), y = n, fill = group)) +
    geom_col(position = "dodge") +     
    scale_fill_manual(name = "Group", labels = c("African Americans", "Asian Americans"), values=c("red","blue")) +
    labs(x = "Values", y = "Frequency",
         title = "Linked hurt",
         subtitle = "Yes = 1, No = 0",
         fill = "Group"), common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_n_count.png")
```


## 3. Analyzing Inter-coder agreement (percentage) and reliability scores

### 3.1. Creating functions

```{r}

extract_kappa <- function(data){
  
 kappa_progress  <- data %>%
      dplyr::select(contains("gains")) %>%
      kappa2("squared")
 
 kappa_hurt <- data %>%
      dplyr::select(contains("losses")) %>%
      kappa2("squared")
 
 data.frame("kappa_progress" = kappa_progress$value, 
            "kappa_hurt" = kappa_hurt$value)
}

extract_agreement <- function(data){
  
 agreement_progress  <- data %>%
      dplyr::select(contains("gains")) %>%
      agree()
 
 agreement_hurt <- data %>%
      dplyr::select(contains("losses")) %>%
      agree()
 
 data.frame("agreement_progress" = agreement_progress$value/100, 
            "agreement_hurt" = agreement_hurt$value/100)
}

```

### 3.2. Applying the functions to each group 

```{r}

irr_summary <- bind_rows(
mutate(
  bind_cols(training_asian %>%
  extract_kappa(),
          training_asian %>%
  extract_agreement()), group = "Asian Americans"),
mutate(
  bind_cols(training_black %>%
  extract_kappa(),
          training_black %>%
  extract_agreement()), group = "African Americans"))

write.csv(irr_summary, "/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/irr_summary.csv")

```

### 3.3. Visualizing agreement and Kappa  

```{r}

irr_summary %>%
  gather(type, value, c(kappa_progress, kappa_hurt)) %>% 
  ggplot(aes(x = fct_reorder(type, value), y = value, fill = group)) +
    geom_col(position = "dodge") +
    coord_flip() +
    scale_fill_manual(name = "Group", labels = c("African Americans", "Asian Americans"), values=c("red","blue")) +
    labs(y= "Intercorder reliability scores", x = "Type",
         title = "Content analysis results",
         subtitle = "Kappa = Cohen's Kappa. Inter-coder reliability score.",
         caption = "Ethnic NewsWatch",
         fill = "Group") + # five thirty eight theme 
    theme(text = element_text(size = 15)) # large font size 

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_kappa.png")

```

## 4. Additional exploratory data analyses 

### 4.1. Visualizing the frequency of agreed topics 

- 100%

```{r}

# Asian Americans
train_asian_plot <- training_asian %>%
  rename(Linked_progress = linked_progress) %>%
  rename(Linked_hurt = linked_hurt) %>%
  gather("linked_fate", "value", Linked_progress, Linked_hurt) %>%
  filter(value == 1) %>%
  filter(Topics_C != "Mismatch") %>%
  filter(Topics_C != "Others") %>%
  group_by(linked_fate) %>%
  count(Topics_C) %>%
  spread(linked_fate, n) %>%
  mutate(Linked_progress = ifelse(is.na(Linked_progress), 0, Linked_progress),
         Linked_hurt = ifelse(is.na(Linked_hurt), 0, Linked_hurt)) %>%
  mutate(difference = Linked_progress - Linked_hurt) %>%
  ggplot(aes(x = fct_reorder(Topics_C, difference), y = difference)) +
    geom_col(position = "dodge") +
    coord_flip() +
    labs(x = "Topics", y = "Difference = N of Linked progress - N of Linked hurt", title = "Asian Americans") +
    ylim(c(-30,20))

# African Americans
train_black_plot <- training_black %>%
  rename(Linked_progress = linked_progress) %>%
  rename(Linked_hurt = linked_hurt) %>%
  gather("linked_fate", "value", Linked_progress, Linked_hurt) %>%
  filter(value == 1) %>%
  filter(Topics_C != "Mismatch") %>%
  group_by(linked_fate) %>%
  count(Topics_C) %>%
  spread(linked_fate, n) %>%
  mutate(Linked_progress = ifelse(is.na(Linked_progress), 0, Linked_progress),
         Linked_hurt = ifelse(is.na(Linked_hurt), 0, Linked_hurt)) %>%
  mutate(difference = Linked_progress - Linked_hurt) %>%
  ggplot(aes(x = fct_reorder(Topics_C, difference), y = difference)) +
    geom_col(position = "dodge") +
    coord_flip() +
    labs(x = "Topics", y = "Difference = N of Linked progress - N of Linked hurt", title = "African Americans")+
    ylim(c(-30,20))

ggarrange(train_asian_plot, train_black_plot, ncol = 1, nrow = 2, common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_topics.png", height = 10)

```

- 50%

```{r}

# Asian Americans
train_asian_plot_gran <- training_asian %>%
  rename(Linked_progress = linked_progress_gran) %>%
  rename(Linked_hurt = linked_hurt_gran) %>%
  gather("linked_fate", "value", Linked_progress, Linked_hurt) %>%
  filter(value == 1) %>%
  filter(Topics_C != "Mismatch") %>%
  filter(Topics_C != "Others") %>%
  group_by(linked_fate) %>%
  count(Topics_C) %>%
  spread(linked_fate, n) %>%
  mutate(Linked_progress = ifelse(is.na(Linked_progress), 0, Linked_progress),
         Linked_hurt = ifelse(is.na(Linked_hurt), 0, Linked_hurt)) %>%
  mutate(difference = Linked_progress - Linked_hurt) %>%
  ggplot(aes(x = fct_reorder(Topics_C, difference), y = difference)) +
    geom_col(position = "dodge") +
    coord_flip() +
    labs(x = "Topics", y = "Difference = N of Linked progress - N of Linked hurt", title = "Asian Americans") +
    ylim(c(-30,20))

# African Americans
train_black_plot_gran <- training_black %>%
  rename(Linked_progress = linked_progress_gran) %>%
  rename(Linked_hurt = linked_hurt_gran) %>%
  gather("linked_fate", "value", Linked_progress, Linked_hurt) %>%
  filter(value == 1) %>%
  filter(Topics_C != "Mismatch") %>%
  group_by(linked_fate) %>%
  count(Topics_C) %>%
  spread(linked_fate, n) %>%
  mutate(Linked_progress = ifelse(is.na(Linked_progress), 0, Linked_progress),
         Linked_hurt = ifelse(is.na(Linked_hurt), 0, Linked_hurt)) %>%
  mutate(difference = Linked_progress - Linked_hurt) %>%
  ggplot(aes(x = fct_reorder(Topics_C, difference), y = difference)) +
    geom_col(position = "dodge") +
    coord_flip() +
    labs(x = "Topics", y = "Difference = N of Linked progress - N of Linked hurt", title = "African Americans")+
    ylim(c(-30,20))

ggarrange(train_asian_plot_gran, train_black_plot_gran, ncol = 1, nrow = 2, common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_topics_gran.png", height = 10)

```

- Comparison 

```{r}
  
(train_asian_plot + labs(subtitle = "Maximum") + train_black_plot + labs(subtitle = "Maximum")) /
(train_asian_plot_gran + labs(subtitle = "Minimum") + train_black_plot_gran + labs(subtitle = "Minimum"))

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_analysis_topics_gran.png", height = 10, width = 15)

```

### 4.2. Visualizing correlation coefficients between the two concepts

```{r}

df %>%
  select(linked_progress, linked_hurt, group) %>%
  group_by(group) %>%
  summarize(corr = cor(linked_progress, linked_hurt), method = "Pearson") %>%
  ggplot(aes(x = fct_reorder(group, corr), y = corr)) +
    geom_col() +
    labs(title = "Correlation Coefficients",
         y = "Pearson Correlation coefficient",
         x = "Group",
         caption = "Ethnic NewsWatch") +
    geom_col() +
    coord_flip()

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/corr_analysis.png")

df %>%
  select(linked_progress_gran, linked_hurt_gran, group) %>%
  group_by(group) %>%
  summarize(corr = cor(linked_progress_gran, linked_hurt_gran), method = "Pearson") %>%
  ggplot(aes(x = fct_reorder(group, corr), y = corr)) +
    geom_col() +
    labs(title = "Correlation Coefficients",
         y = "Pearson Correlation coefficient",
         x = "Group",
         caption = "Ethnic NewsWatch") +
    geom_col() +
    coord_flip()

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/corr_analysis_gran.png")
```


## 5. Reading texts 

- Merging the text files with the content analysis 

```{r}

sample_asian <- read_rds("/home/jae/content-analysis-for-evaluating-ML-performances/raw_data/sample_asian.rds")
sample_black <- read_rds("/home/jae/content-analysis-for-evaluating-ML-performances/raw_data/sample_black.rds")

sample_asian <- bind_cols(sample_asian, training_asian %>% select(linked_progress, linked_hurt, linked_progress_gran, linked_hurt_gran, Topics_C))
sample_black <- bind_cols(sample_black, training_black %>% select(linked_progress, linked_hurt, linked_progress_gran, linked_hurt_gran, Topics_C))

```

- Comparing 100% and 50% data 

```{r}

# Merge 

df <- bind_rows(mutate(sample_asian, group = "Asian Americans"),
          mutate(sample_black, group = "African Americans"))

# Select 

df <- df %>% select(source, year, group, linked_progress, linked_progress_gran, 
              linked_hurt, linked_hurt_gran)

# Mutate 

df <- df %>% 
  mutate(lp_exclusive = ifelse(linked_progress == 1 & linked_hurt == 0, 1, 0),
         lh_exclusive = ifelse(linked_progress == 0 & linked_hurt == 1, 1, 0),
         lf_mixed = ifelse(linked_progress == 1 & linked_hurt == 1, 1, 0)) %>%
  mutate(lp_exclusive_gran = ifelse(linked_progress_gran == 1 & linked_hurt_gran == 0, 1, 0),
         lh_exclusive_gran= ifelse(linked_progress_gran == 0 & linked_hurt_gran == 1, 1, 0),
         lf_mixed_gran = ifelse(linked_progress_gran == 1 & linked_hurt_gran == 1, 1, 0))

# Remove numbers and special characters in the source titles 

df$source <- gsub('[[:digit:]]', '', df$source) 
df$source <- gsub('[[:punct:]]+', '', df$source) %>% trimws()

```

- Non-excluded 

```{r}

# Gather, group by and summary, and mutate

df_source <- df %>% 
  gather(linked_fate, value, c(lp_exclusive, lh_exclusive, lf_mixed, lp_exclusive_gran, lh_exclusive_gran, lf_mixed_gran)) %>%
  group_by(linked_fate, group, source) %>%
  summarize_content()

# Create two additional columns for sorting 

df_source$type <- ifelse(str_detect(df_source$linked_fate, "gran"), "Minimum", "Maximum")
df_source$linked_fate <- str_replace(df_source$linked_fate, "_gran", "")

```

```{r}

# Visualize 

plot_asian <- df_source %>%
 filter(group == "Asian Americans") %>%
 ggplot(aes(x = fct_reorder(type, mean), y = mean, fill = linked_fate)) +
    geom_bar(stat="identity", color="black", 
             position=position_dodge()) +
    geom_errorbar(aes(ymin= lower.ci, ymax = upper.ci), width=.2,
                  position=position_dodge(.9)) +
    facet_wrap(~source) +
    scale_fill_manual(name = "Type", labels = c("Mixed","Linked hurt","Linked progress"), values=c("purple","red","blue")) +
    scale_y_continuous(labels = scales::percent) +
    labs(subtitle = "Asian Americans", y = "Proportion", x = "Measurement")

plot_black <- df_source %>%
 filter(group != "Asian Americans") %>%
 ggplot(aes(x = fct_reorder(type, mean), y = mean, fill = linked_fate)) +
    geom_bar(stat="identity", color="black", 
             position=position_dodge()) +
    geom_errorbar(aes(ymin= lower.ci, ymax = upper.ci), width=.2,
                  position=position_dodge(.9)) +
    facet_wrap(~source) +
    scale_fill_manual(name = "Type", labels = c("Mixed","Linked hurt","Linked progress"), values=c("purple","red","blue")) +
    scale_y_continuous(labels = scales::percent) +
    labs(subtitle = "African Americans", y = "Proportion", x = "Measurement")

ggarrange(plot_asian, plot_black, common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_data_sources.png", width = 15)
```
- Compare moderate and extreme cases 

```{r}

df_ratio <- df %>%
  mutate(extreme = lp_exclusive + lh_exclusive,
         extreme_gran = lp_exclusive_gran + lh_exclusive_gran,
         moderate = lf_mixed, 
         moderate_gran = lf_mixed_gran) %>%
  gather(linked_fate, value, c(extreme, extreme_gran, moderate, moderate_gran)) %>%
  group_by(linked_fate, group, source) %>%
  summarize_content()

df_ratio$type <- ifelse(str_detect(df_ratio$linked_fate, "gran"), "Minimum", "Maximum")
df_ratio$linked_fate <- str_replace(df_ratio$linked_fate, "_gran", "")
  
ggarrange(
  df_ratio %>%
  filter(group == "Asian Americans") %>%
  ggplot(aes(x = fct_reorder(type, mean), y = mean, fill = linked_fate)) +
    geom_bar(stat="identity", color="black", 
             position=position_dodge()) +
    geom_errorbar(aes(ymin= lower.ci, ymax = upper.ci), width=.2,
                  position=position_dodge(.9)) +
    scale_fill_manual(name = "Type", labels = c("Extreme","Moderate"), values=c("red","blue")) +
    facet_wrap(~source) +
    ylim(c(0, 0.7)) +    
    scale_y_continuous(labels = scales::percent) +
    labs(title = "", subtitle = "Asian Americans", y = "Proportion", x = "Measurement"),

  df_ratio %>%
  filter(group != "Asian Americans") %>%
  ggplot(aes(x = fct_reorder(type, mean), y = mean, fill = linked_fate)) +
    geom_bar(stat="identity", color="black", 
             position=position_dodge()) +
    geom_errorbar(aes(ymin= lower.ci, ymax = upper.ci), width=.2,
                  position=position_dodge(.9)) +
    scale_fill_manual(name = "Type", labels = c("Extreme","Moderate"), values=c("red","blue")) +
    facet_wrap(~source) +
    ylim(c(0, 0.7)) +   
    scale_y_continuous(labels = scales::percent) +
    labs(title = "", subtitle = "African Americans", y = "Proportion", x = "Measurement"), common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/content_data_sources_comp.png", width = 15)
```

## 6. Exporting non-duplicated files 

```{r}

# Non-duplicated 
sample_asian <- sample_asian[!duplicated(sample_asian$text),]
sample_black <- sample_black[!duplicated(sample_black$text),]

# Check 
1008 - nrow(sample_asian)
1008 - nrow(sample_black)

# Export 
write.csv(sample_asian, "/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/sample_asian.csv")
write.csv(sample_black, "/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/sample_black.csv")

```

