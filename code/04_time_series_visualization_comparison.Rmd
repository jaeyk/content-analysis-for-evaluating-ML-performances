---
title: "Comparing the results"
author: "Jae Yeon Kim"
output:
html_document: 
  toc: true
  theme: united
---

## 0. Setup 

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        irr, # for calculating inter-coder reliability score
        corrplot, # for visualizing correlation coefficients
        ggpubr, # for arranging ggplots 
        ggthemes # for fancy ggplot themes
)

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/theme_publications.r")
theme_set(theme_Publication(14))

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/text_analysis.r")

```

## 1. Import files 

```{r include=FALSE}

full_articles <- read_csv("/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/full_articles.csv")
full_articles_gran <- read_csv("/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/full_articles_gran.csv")

```

### 2. Merge data 

```{r}

df <- bind_rows(mutate(full_articles, type = "Maximum"),
          mutate(full_articles_gran, type = "Minimum")) %>%
     mutate(group = factor(group, levels = c("Asian Americans", "African Americans")))

```

### 3. Visualize data 

- Year 

```{r}

df %>%
  filter(year >= 1976 & year <= 1981) %>%
  gather(linked_fate, value, lp_exclusive, lh_exclusive, lf_mixed) %>%
  group_by(group, linked_fate, type) %>%
  summarize(mean = round(mean(value),2),
            sd  = sd(value),
            n = n()) %>%
  mutate(se = sd / sqrt(n), # calculate standard errors and confidence intervals 
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se) %>%
  ggplot(aes(x = fct_reorder(group, mean), y = mean, fill = linked_fate)) +
    geom_bar(stat="identity", color="black", 
             position=position_dodge()) +
    geom_errorbar(aes(ymin= lower.ci, ymax = upper.ci), width=.2,
                   position=position_dodge(.9)) +
    facet_wrap(~type) +
    scale_fill_manual(name = "Type", labels = c("Mixed","Linked hurt","Linked progress"), values=c("purple","red","blue")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 5L)) +
    geom_text(aes(label = paste(mean*100, "%")), position=position_dodge(width=0.9), vjust=-1.5) +
    labs(title = "Matched comparison (1976-1981)", y = "Proportion of articles", x = "Group") 

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_year.png", height = 7)
```

- Source

```{r}

plot_asian <- df %>%
  filter(group == "Asian Americans") %>%
  gather(linked_fate, value, lp_exclusive, lh_exclusive, lf_mixed) %>%
  group_by(linked_fate, type, source) %>%
  visualize_aggregated() +
    labs(title = "Aggregated differences", subtitle = "Asian Americans", y = "Proportion of articles", x = "Group") 

plot_black <- df %>%
  filter(group != "Asian Americans") %>%
  gather(linked_fate, value, lp_exclusive, lh_exclusive, lf_mixed) %>%
  group_by(linked_fate, type, source) %>%
  visualize_aggregated() +
    labs(title = "", subtitle = "African Americans", y = "Proportion of articles", x = "Group") 

ggarrange(plot_asian, plot_black, common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_source.png", width = 13, height = 7)

```
- Extreme versus moderate cases 

```{r}

plot_asian <- df %>%
  filter(group == "Asian Americans") %>%
  mutate(extreme = lp_exclusive + lh_exclusive) %>%
  gather(linked_fate, value, extreme, lf_mixed) %>%
  group_by(linked_fate, type, source) %>%
  visualize_comp() +
    scale_fill_manual(name = "Type", labels = c("Extreme","Moderate"), values=c("red","blue")) +
    labs(title = "Aggregated differences", subtitle = "Asian Americans", y = "Proportion of articles", x = "Group") 

plot_black <- df %>%
  filter(group != "Asian Americans") %>%
  mutate(extreme = lp_exclusive + lh_exclusive) %>%
  gather(linked_fate, value, extreme, lf_mixed) %>%
  group_by(linked_fate, type, source) %>%
  visualize_comp() +
    scale_fill_manual(name = "Type", labels = c("Extreme","Moderate"), values=c("red","blue")) +
    labs(title = "", subtitle = "African Americans", y = "Proportion of articles", x = "Group") 

ggarrange(plot_asian, plot_black, common.legend = TRUE)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_comp.png", width = 16, height = 7)

```

- Ratio 

```{r}

matched_ratio <- df %>%
  filter(year >= 1976 & year <= 1981) %>%
  visualize_ratio() +
    labs(title = "Matched (1976-1981)", y = "Ratio", x = "Group") + ylim(c(0,16))
            
unmatched_ratio <- df %>%
 visualize_ratio() +
    labs(title = "Unmatched (1968-1981)", y = "Ratio", x = "Group") + ylim(c(0,16))

matched_ratio

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_matched.png", width = 8)

unmatched_ratio

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_unmatched.png", width = 8)

```

- Ratio + Source 

```{r}

plot_asian_ratio <- df %>%
  filter(group == "Asian Americans") %>%
  visualize_ratio_source() +
    labs(subtitle = "Asian Americans", y = "Ratio", x = "Measurement") 

plot_black_ratio <- df %>%
  filter(group != "Asian Americans") %>%
  visualize_ratio_source() +
    labs(subtitle = "African Americans", y = "Ratio", x = "Measurement") 

ggarrange(plot_asian_ratio, plot_black_ratio, common.legend = TRUE, ncol = 1)

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/matched_comparison_ratio_year.png", height = 10)

```