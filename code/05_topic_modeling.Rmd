---
title: "Topic modeling analysis"
author: "Jae Yeon Kim"
output:
html_document:
  toc: true
  theme: united
---

# Setup

## 0. Setup

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        irr, # for calculating inter-coder reliability score
        corrplot, # for visualizing correlation coefficients
        ggpubr, # for arranging ggplots
        ggthemes, # for fancy ggplot themes
        tidytext, # for tidytext
        stm, # for structural topic modeling
        tidystm, # for extracting estimated effects from stm
        furrr, # for multiprocessing
        patchwork, # for arranging images
        scales, # for scales 
        readr # for importing and exporting files 
)

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/text_analysis.r")

source("/home/jae/content-analysis-for-evaluating-ML-performances/functions/theme_publications.r")

theme_set(theme_Publication(14))
```

## 1. Import files

```{r include=FALSE}

setwd("/home/jae/content-analysis-for-evaluating-ML-performances/raw_data/")

asian_unlabeled <- read_csv("asian_full.csv") %>%
  mutate(group = c("Asian Americans"))
black_unlabeled<- read_csv("black_full.csv") %>%
  mutate(group = c("African Americans"))

# Merge them 
full_articles <- rbind(asian_unlabeled, black_unlabeled)

glimpse(full_articles)

```

## 2. Clean and wrangle data

```{r}

# Manipulate strings
full_articles$source <- gsub('[[:digit:]]', '', full_articles$source) 
full_articles$source <- gsub('[[:punct:]]+', '', full_articles$source) %>% trimws()

```

## 3. Structural topic modeling

I adapted the code from Julia Silge's [amazing STM tutotial](https://juliasilge.com/blog/evaluating-stm/).

### 3.1. Preprocessing

```{r}

# Divide five newspapers 

asian <- full_articles %>% filter(group == "Asian Americans")
black <- full_articles %>% filter(group != "Asian Americans")

# Clean and create a document-term matrix

cleaned_dtm <- function(corpus, meta){
  
      processed <- textProcessor(documents = corpus, 
                                 metadata = meta,
                                 removenumbers = TRUE,
                                 removestopwords = TRUE, 
                                 removepunctuation = TRUE, 
                                 lowercase = TRUE, 
                                 stem = TRUE, 
                                 verbose = TRUE)

      out <- prepDocuments(processed$documents, 
                           processed$vocab, 
                           processed$meta)
      
      out}

# Apply to each file 

asian_out <- cleaned_dtm(asian$text, asian)

Sys.sleep(10)
```

```{r}

black_out <- cleaned_dtm(black$text, black)

```

```{r}

write_rds(asian_out, "/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/asian_out.rds")

write_rds(black_out, "/home/jae/content-analysis-for-evaluating-ML-performances/processed_data/black_out.rds")

Sys.sleep(10)
```

### 3.2. Train and evaluate a topic model

#### 3.2.1. Train many models

For the parallel processing, I referred the code from [this site](https://byuistats.github.io/M335/parallel_furrr.html).

```{r include=FALSE}

no_cores <- availableCores() - 1

plan(multicore, workers = no_cores)

asian_many_models <- data_frame(K = c(10:15)) %>%
  mutate(topic_model = future_map(K, ~stm(asian_out$documents, asian_out$vocab, K = .)))
  
Sys.sleep(10)

```

```{r}
  
black_many_models <- data_frame(K = c(10:15)) %>%
  mutate(topic_model = future_map(K, ~stm(black_out$documents, black_out$vocab, K = .)))

```

#### 3.2.2. Visualize diagnostics

```{r eval=FALSE, include=FALSE}

asian_diag <- visualize_diagnostics(asian_out, asian_many_models) + labs(subtitle = "Linked progress articles") 
lh_diag <- visualize_diagnostics(black_lh_articles_sparse, black_many_models) + labs(subtitle = "Linked hurt articles") 

lp_diag / lh_diag

ggsave("/home/jae/content-analysis-for-evaluating-ML-performances/outputs/topic_modeling_diagnosis_plot.png", height = 10)

```